name: Deploy Frontend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'

env:
  PROJECT_ID: solar-safeguard-476315-p0
  REGION: us-central1
  SERVICE_NAME: koordie-frontend
  REPOSITORY: koordie-repo

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        run: |
          echo "üîê Validating required secrets for frontend deployment..."
          missing=""

          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            missing="$missing GCP_SA_KEY"
          fi

          if [ -z "${{ secrets.GOOGLE_MAPS_API_KEY }}" ]; then
            missing="$missing GOOGLE_MAPS_API_KEY"
          fi

          if [ -n "$missing" ]; then
            echo ""
            echo "‚ùå MISSING REQUIRED SECRETS:$missing"
            echo ""
            echo "These secrets are required for frontend deployment."
            echo "Add them at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "Required secrets:"
            echo "  - GCP_SA_KEY: Google Cloud service account JSON key"
            echo "  - GOOGLE_MAPS_API_KEY: Google Maps API key for address autocomplete"
            echo ""
            exit 1
          fi

          echo "‚úÖ All required secrets present"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Validate Frontend
        run: |
          cd frontend
          echo "üì¶ Installing dependencies..."
          npm ci

          echo "üî® Building frontend..."
          npm run build

          echo "‚úÖ Verifying build output..."
          if [ ! -f dist/index.html ]; then
            echo "‚ùå Build failed - no index.html generated"
            exit 1
          fi

          if [ ! -d dist/assets ]; then
            echo "‚ùå Build failed - no assets directory"
            exit 1
          fi

          echo "‚úÖ Build validation passed"

      - name: Build and push Docker image
        id: docker_build
        run: |
          cd frontend

          # Build Docker image
          docker build \
            --build-arg VITE_API_URL=https://api.koordie.com/api \
            --build-arg VITE_GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest .

          # Extract and verify the built bundle before pushing
          echo "üîç Verifying Google Maps API key in Docker build..."
          CONTAINER_ID=$(docker create ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }})
          docker cp $CONTAINER_ID:/usr/share/nginx/html/assets ./docker-dist-assets
          docker rm $CONTAINER_ID

          # Check for empty API key (indicates build failure)
          if grep -q 'googleMapsApiKey:""' ./docker-dist-assets/*.js 2>/dev/null; then
            echo ""
            echo "‚ùå BUILD ERROR: Google Maps API key is EMPTY in the production bundle!"
            echo ""
            echo "This means the GOOGLE_MAPS_API_KEY secret was not properly injected."
            echo "Check that the secret exists and has a valid value."
            echo ""
            rm -rf ./docker-dist-assets
            exit 1
          fi

          # Verify key is present (look for AIzaSy prefix)
          if grep -q 'AIzaSy' ./docker-dist-assets/*.js 2>/dev/null; then
            echo "‚úÖ Google Maps API key verified in production bundle"
          else
            echo "‚ö†Ô∏è  WARNING: Could not verify Google Maps API key format in bundle"
            echo "The key may be present but in an unexpected format"
          fi

          rm -rf ./docker-dist-assets

          # Push verified images
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --quiet

          # Ensure traffic is routed to the latest revision
          # This prevents issues where traffic gets stuck on an old revision
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-latest

      - name: Smoke Test Frontend
        run: |
          echo "‚è≥ Waiting for service to be ready..."
          sleep 10

          FRONTEND_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "üîç Testing: $FRONTEND_URL"

          # Fetch the page
          RESPONSE=$(curl -s "$FRONTEND_URL")

          # Check for root element
          if echo "$RESPONSE" | grep -q 'id="root"'; then
            echo "‚úÖ Root element present"
          else
            echo "‚ùå Root element missing - app may not load"
            exit 1
          fi

          # Check if JavaScript bundle is referenced
          JS_FILE=$(echo "$RESPONSE" | grep -oP 'src="/assets/index-[^"]+\.js"' | head -1 | tr -d 'src="')
          if [ -n "$JS_FILE" ]; then
            echo "üì¶ JavaScript bundle: $JS_FILE"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL$JS_FILE")
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ JavaScript bundle loads successfully"
            else
              echo "‚ùå JavaScript bundle returned HTTP $HTTP_CODE"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Warning: Could not find JavaScript bundle reference"
          fi

          # Check if CSS is referenced
          CSS_FILE=$(echo "$RESPONSE" | grep -oP 'href="/assets/index-[^"]+\.css"' | head -1 | tr -d 'href="')
          if [ -n "$CSS_FILE" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL$CSS_FILE")
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ CSS loads successfully"
            fi
          fi

          # Verify Google Maps API key is in the deployed bundle
          if [ -n "$JS_FILE" ]; then
            JS_CONTENT=$(curl -s "$FRONTEND_URL$JS_FILE")
            if echo "$JS_CONTENT" | grep -q 'googleMapsApiKey:""'; then
              echo ""
              echo "‚ùå CRITICAL: Google Maps API key is EMPTY in deployed bundle!"
              echo "This will break address autocomplete for users."
              echo "Check GOOGLE_MAPS_API_KEY secret in GitHub."
              echo ""
              exit 1
            elif echo "$JS_CONTENT" | grep -q 'AIzaSy'; then
              echo "‚úÖ Google Maps API key present in bundle"
            else
              echo "‚ö†Ô∏è  Could not verify Google Maps API key in bundle"
            fi
          fi

          echo "‚úÖ Frontend smoke test passed"

      - name: Show deployment URL
        run: |
          echo "Frontend deployed successfully!"
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)'

      - name: Notify on Failure
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå FRONTEND DEPLOYMENT FAILED"
          echo "=========================================="
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "This failure has been logged. Check your email for GitHub Actions notifications."
          echo "To enable email notifications:"
          echo "  1. Go to https://github.com/settings/notifications"
          echo "  2. Enable 'Actions' under 'Email notification preferences'"
          echo ""
