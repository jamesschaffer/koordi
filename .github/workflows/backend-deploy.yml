name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  PROJECT_ID: solar-safeguard-476315-p0
  REGION: us-central1
  SERVICE_NAME: koordie-backend
  REPOSITORY: koordie-repo

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Validate Backend
        run: |
          cd backend
          echo "üì¶ Installing dependencies..."
          npm ci

          echo "üî® Building backend..."
          npm run build

          echo "‚úÖ Verifying build output..."
          if [ ! -d dist ]; then
            echo "‚ùå Build failed - no dist directory"
            exit 1
          fi

          if [ ! -f dist/index.js ]; then
            echo "‚ùå Build failed - no index.js generated"
            exit 1
          fi

          echo "‚úÖ Build validation passed"

      - name: Build and push Docker image
        run: |
          cd backend
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }} \
                       -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest

      # TODO: Re-enable automated migrations with Cloud SQL Proxy
      # - name: Run database migrations
      #   run: |
      #     cd backend
      #     # Install dependencies and run migrations
      #     npm ci
      #     DATABASE_URL="${{ secrets.DATABASE_URL }}" npx prisma migrate deploy
      #
      # For now, run migrations manually from Cloud Run or local with production DB access

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars=NODE_ENV=production,FRONTEND_URL=https://app.koordie.com,GOOGLE_REDIRECT_URI=https://api.koordie.com/api/auth/google/callback \
            --update-secrets=SMTP_HOST=SMTP_HOST:latest,SMTP_PORT=SMTP_PORT:latest,SMTP_SECURE=SMTP_SECURE:latest,SMTP_USER=SMTP_USER:latest,SMTP_PASS=SMTP_PASS:latest,EMAIL_FROM=EMAIL_FROM:latest \
            --quiet

      - name: Validate Configuration
        run: |
          echo "üîç Validating production configuration..."
          chmod +x scripts/validate-prod-config.sh
          ./scripts/validate-prod-config.sh

      - name: Health Check
        run: |
          echo "Waiting for service to be ready..."
          sleep 15
          HEALTH_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')/api/health

          echo "Checking health endpoint..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          HEALTH_BODY=$(echo "$HEALTH_RESPONSE" | head -n-1)

          echo "Response:"
          echo "$HEALTH_BODY" | jq '.'

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Health check passed - all systems healthy"
          elif [ "$HTTP_CODE" -eq 503 ]; then
            echo "‚ö†Ô∏è  Service degraded but running"
            echo "$HEALTH_BODY" | jq '.checks'
            echo "Deployment will continue but issues detected above"
          else
            echo "‚ùå Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Smoke Test API Endpoints
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "üîç Testing API endpoints at: $BACKEND_URL"

          # Test /api root endpoint
          API_RESPONSE=$(curl -s "$BACKEND_URL/api")
          if echo "$API_RESPONSE" | grep -q '"message":"Koordie API"'; then
            echo "‚úÖ API root endpoint responding correctly"
          else
            echo "‚ùå API root endpoint returned unexpected response:"
            echo "$API_RESPONSE"
            exit 1
          fi

          # Test /api/health (already tested above, but verify structure)
          HEALTH_STATUS=$(echo "$HEALTH_BODY" | jq -r '.status')
          if [ "$HEALTH_STATUS" = "healthy" ] || [ "$HEALTH_STATUS" = "degraded" ]; then
            echo "‚úÖ Health endpoint returns valid structure"
          else
            echo "‚ùå Health endpoint structure invalid"
            exit 1
          fi

          echo "‚úÖ Backend smoke tests passed"

      - name: Show deployment URL
        run: |
          echo "Backend deployed successfully!"
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)'

      - name: Notify on Failure
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå BACKEND DEPLOYMENT FAILED"
          echo "=========================================="
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "This failure has been logged. Check your email for GitHub Actions notifications."
          echo "To enable email notifications:"
          echo "  1. Go to https://github.com/settings/notifications"
          echo "  2. Enable 'Actions' under 'Email notification preferences'"
          echo ""
